# CancelSubnet
A collection of tools to enable a user to request cancellation of Subnets from our classic infrastructure Performance VLAN  

Note that a Jenkins job exists to automate the steps described below. See https://alchemy-testing-jenkins.swg-devops.com/job/Armada-Performance/job/Automation/job/IdentifyUnboundSubnets/  

## Identify Unused Subnets
A bash script that will retrieve a list of subnets for our private or public performance VLAN (2263901/2263903), and identify those subnets that have a IKS/ROKS cluster bound to them. Any that are identified as "Not In Use" can be subsequently deleted using the CancelSubnet tool.  

Before executing the script you must first ensure that the perf-metadata.toml files for all carriers are available locally in the \<armada-perf-repo-root\>/armada-perf-client2/config folder. These files can be generated by https://alchemy-containers-jenkins.swg-devops.com/job/Armada-Performance/job/perfClient-setup/job/Build-and-Copy-perf-repo/

To run:  
`
./identifyUnusedSubnets.sh [private | public]
`  

Output format is  

\<subnet-id\> - \<subnet-display-label\> : \<bound-cluster | NOT IN USE\>

For example:
```
Subnet use on VLAN 2263903

Checking Carrier 2 for subnet usage
Checking Carrier 3 for subnet usage
Checking Carrier 4 for subnet usage
Checking Carrier 5 for subnet usage

ID        DISPLAY LABEL       STATUS
--        -------------       ------
982235  - 169.55.197.64/29  : NOT IN USE
1208767 - 169.55.2.192/29   : NOT IN USE
1008273 - 169.55.237.200/29 : NOT IN USE
2035429 - 169.55.201.216/29 : NOT IN USE
2035447 - 169.54.217.104/29 : NOT IN USE
2035421 - 169.55.223.152/29 : NOT IN USE
1848267 - 169.44.3.0/24     : PRIMARY
855985  - 169.54.227.104/29 : NOT IN USE
1844987 - 169.55.241.64/29  : NOT IN USE
2035427 - 169.55.201.208/29 : rgs18-1 (biiackt203rgqe3h4cdg)
850779  - 169.54.224.8/29   : NOT IN USE
1047941 - 169.55.198.80/29  : NOT IN USE
2031811 - 169.55.25.128/29  : NOT IN USE
1848265 - 169.44.2.0/24     : PRIMARY
982859  - 169.55.198.16/29  : Perf32-20190405-auto11 (bijkq7520q9t5anr96i0)
827939  - 169.54.202.56/29  : rgs1 (bid4qpo20eiqbe4gb9h0)
2025577 - 169.55.249.48/29  : NOT IN USE
1021405 - 169.55.249.0/29   : NOT IN USE
1241603 - 169.55.242.168/29 : NOT IN USE
1230755 - 169.55.204.72/29  : NOT IN USE
1272345 - 169.55.17.176/29  : NOT IN USE
896527  - 169.55.27.128/29  : NOT IN USE
994367  - 169.55.55.72/29   : dg2aTest1 (bi53g5s203jij7v026fg)
871089  - 169.54.253.0/29   : NOT IN USE
2035453 - 169.55.41.112/29  : Perf41-20190404-auto1 (bij7n9420ia3kcjfovn0)
2035445 - 169.54.217.96/29  : NOT IN USE
972191  - 169.55.51.144/29  : NOT IN USE
1798025 - 169.55.15.104/29  : NOT IN USE
1828725 - 169.44.1.0/24     : PRIMARY
887393  - 169.55.14.168/29  : NOT IN USE
982237  - 169.55.197.72/29  : realcruiser-perf-3 (bid1e5h20o37mi4t2a40)
2031813 - 169.55.25.136/29  : JS1 (bijiact202c4icbfovq0)
895235  - 169.55.22.144/29  : NOT IN USE
1200651 - 169.45.137.16/29  : Perf31-20190404-auto1 (bij74do20mqorinr96hg)
```



## Cancel Subnet

A golang tool that uses the Softlayer API to request cancellation of the specified subnet. Expected use would be to first identify an unused subnet using the `identifyUnusedSubnets` command above

The tool requires the user to provide the credentials for accessing Softlayer resources. These should be provided via the following environment variables  

`
PROD_GLOBAL_ARMPERF_SOFTLAYER_<ACCOUNT>_USERID  
PROD_GLOBAL_ARMPERF_SOFTLAYER_<ACCOUNT>_APIKEY
`  

N.B. For our everyday testing, the account should be `1186049`

For example:  

`export PROD_GLOBAL_ARMPERF_SOFTLAYER_1186049_USERID=1186049_<your-email\>  `

`export PROD_GLOBAL_ARMPERF_SOFTLAYER_1186049_APIKEY=<your classic infrastrcuture api key for 1186049 account>  ` <!-- pragma: allowlist secret -->

Then run:  
`
./cancelSubnet -subnet=<subnet-display-label> [-private | -public]
`  

Example output:
```
$ ./cancelSubnet -subnet=169.55.3.144/29 -public
2019/04/05 11:44:13 Opening session with Softlayer
2019/04/05 11:44:13 Getting data from Softlayer
2019/04/05 11:44:15 Processing VLAN: "Stagepa/PerfCr/US" - 1122
2019/04/05 11:44:15 About to cancel subnet "169.55.3.144/29". Are you sure ? (Enter yes to confirm)
yes
2019/04/05 11:44:18 Cancelling "169.55.3.144/29"
2019/04/05 11:44:20 "169.55.3.144/29" successfully cancelled.

```
